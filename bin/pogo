#!/usr/bin/env php
<?php
ini_set('display_errors', 1);
putenv('POGO_SCRIPT=');
putenv('POGO_AUTOLOAD=');
putenv('POGO_STDIN=');
$found = 0;
$autoloaders = array(
  dirname(__DIR__) . DIRECTORY_SEPARATOR . 'vendor' . DIRECTORY_SEPARATOR . 'autoload.php',
  dirname(dirname(dirname(__DIR__))) . DIRECTORY_SEPARATOR . 'autoload.php'
);
foreach ($autoloaders as $autoloader) {
  if (file_exists($autoloader)) {
    require_once $autoloader;
    $found = 1;
    break;
  }
}
if (!$found) {
  die("Failed to find autoloader");
}

function pogo_main(\Pogo\PogoInput $input) {
  $actions = [
    'run' => new \Pogo\Command\RunCommand(),
    'get' => new \Pogo\Command\DownloadCommand(),
    'up' => new \Pogo\Command\UpdateCommand(),
    'parse' => new \Pogo\Command\ParseCommand(),
    'help' => new \Pogo\Command\HelpCommand(),
  ];

  if (empty($input->action) && !empty($input->script)) {
    $exit = $actions['run']->run($input);
    exit($exit === NULL ? 0 : $exit);
  }
  elseif (isset($actions[$input->action])) {
    $exit = $actions[$input->action]->run($input);
    exit($exit === NULL ? 0 : $exit);
  }
  else {
    $actions['help']->run($input);
    return 1;
  }
}

pogo_main(\Pogo\PogoInput::create($argv));
